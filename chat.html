<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Chat em tempo real</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; padding:0; display:flex; height:100vh; }
    .left { width:320px; padding:12px; border-right:1px solid #ddd; box-sizing:border-box;background:#f7f7f7;}
    .main { flex:1; display:flex; flex-direction:column; }
    #log { flex:1; padding:12px; overflow:auto; white-space:pre-wrap; }
    #compose { display:flex; padding:8px; border-top:1px solid #ddd; }
    #msg { flex:1; padding:8px; font-size:14px; }
    button { padding:8px 12px; margin-left:8px; }
    .system { color:#666; font-style:italic; }
  </style>
</head>
<body>
  <div class="left">
    <h3>Entrar no chat</h3>
    <label>Servidor (IP ou host):<br/><input id="server" value="localhost" /></label><br/><br/>
    <label>Porta:<br/><input id="port" value="6789" /></label><br/><br/>
    <label>Nick:<br/><input id="nick" /></label><br/><br/>
    <button id="btnConnect">Conectar</button>
    <button id="btnDisconnect" disabled>Desconectar</button>
    <hr/>
    <small>Abra este arquivo em outros computadores e conecte ao mesmo servidor.</small>
  </div>

  <div class="main">
    <div id="log"></div>
    <div id="compose">
      <input id="msg" placeholder="Digite sua mensagem..." />
      <button id="send" disabled>Enviar</button>
    </div>
  </div>

<script>
let ws = null;
const log = document.getElementById('log');
const serverInput = document.getElementById('server');
const portInput = document.getElementById('port');
const nickInput = document.getElementById('nick');
const btnConnect = document.getElementById('btnConnect');
const btnDisconnect = document.getElementById('btnDisconnect');
const sendBtn = document.getElementById('send');
const msgInput = document.getElementById('msg');

function append(text, cls){
  const el = document.createElement('div');
  if(cls) el.className = cls;
  el.textContent = text;
  log.appendChild(el);
  log.scrollTop = log.scrollHeight;
}

btnConnect.onclick = () => {
  const server = serverInput.value.trim();
  const port   = portInput.value.trim();
  const nick   = nickInput.value.trim();

  if(!nick){
    alert("Informe um nick");
    return;
  }

  // Detectar se é Render
  let protocol;
  let url;

  if (server.includes("onrender.com")) {
    protocol = "wss";
    url = `${protocol}://${server}`;   // Render não usa porta visível
  } else {
    protocol = "ws";
    url = `${protocol}://${server}:${port}`;
  }

  append("Conectando a " + url + "...", "system");

  try {
    ws = new WebSocket(url);
  } catch(e) {
    append("Erro ao criar WebSocket: " + e, "system");
    return;
  }

  ws.onopen = () => {
    append('Conectado ao ' + url, 'system');
    ws.send(JSON.stringify({type:'join', nick: nick}));
    btnConnect.disabled = true;
    btnDisconnect.disabled = false;
    sendBtn.disabled = false;
  };

  ws.onmessage = (ev) => {
    try {
      const obj = JSON.parse(ev.data);
      if(obj.type === 'broadcast') append(obj.text);
      else if(obj.type === 'system') append(obj.text, 'system');
      else append(JSON.stringify(obj));
    } catch(e) {
      append(ev.data);
    }
  };

  ws.onclose = () => {
    append('Desconectado', 'system');
    btnConnect.disabled = false;
    btnDisconnect.disabled = true;
    sendBtn.disabled = true;
  };

  ws.onerror = (e) => {
    append("Erro no WebSocket (ver console)", "system");
    console.error(e);
  };
};

btnDisconnect.onclick = () => {
  if(ws) ws.close();
  ws = null;
  btnConnect.disabled = false;
  btnDisconnect.disabled = true;
  sendBtn.disabled = true;
};

sendBtn.onclick = () => {
  const text = msgInput.value.trim();
  if(!text || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({type:'msg', msg: text}));
  msgInput.value = '';
  msgInput.focus();
};

msgInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter') sendBtn.click();
});
</script>
</body>
</html>
